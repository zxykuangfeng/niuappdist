"use strict";var e=Object.defineProperty,s=(s,t,r)=>(((s,t,r)=>{t in s?e(s,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):s[t]=r})(s,"symbol"!=typeof t?t+"":t,r),r);const t=require("../common/vendor.js"),r=require("../stores/member.js"),i=require("../locale/index.js"),o=require("./common.js");const n=new class{constructor(){s(this,"baseUrl"),s(this,"config",{url:"",header:{}}),this.baseUrl="http://ssz.sszwl.com/api/","/"!=this.baseUrl.substr(-1)&&(this.baseUrl+="/");try{this.config.header["site-id"]=o.getSiteId("100000"),this.config.header.channel=o.getAppChannel()}catch(e){}}requestInterceptors(){try{o.getToken()&&(this.config.header.token=o.getToken()),this.config.header.channel=o.getAppChannel(),this.config.header["site-id"]=o.getSiteId("100000")}catch(e){}}get(e,s={},t={}){return this.request("GET",e,s,t)}post(e,s={},t={}){return this.request("POST",e,s,t)}put(e,s={},t={}){return this.request("PUT",e,s,t)}delete(e,s={},t={}){return this.request("DELETE",e,s,t)}upload(e,s={},r={}){this.requestInterceptors();const i=Object.assign(t.index.$u.deepClone(this.config),r,{url:this.baseUrl+e,...s});return new Promise(((e,s)=>{t.index.uploadFile({...i,success:r=>{const i=JSON.parse(r.data);1==i.code?(this.config.showSuccessMessage&&t.index.showToast({title:i.msg,icon:"none"}),e(i)):(0==i.code||400==i.code?!1!==this.config.showErrorMessage&&t.index.showToast({title:i.msg,icon:"none"}):this.handleAuthError(i.code),s(i))},fail:e=>{s(e)}})}))}request(e,s,r,i={}){this.requestInterceptors();const o=Object.assign(t.index.$u.deepClone(this.config),i,{url:this.baseUrl+s,method:e});return"GET"==o.method.toUpperCase()||"DELETE"==o.method.toUpperCase()?o.url+="?"+t.lib.stringify(r):o.data=r,new Promise(((e,s)=>{t.index.request({...o,success:r=>{const o=r.data;1==o.code?(i.showSuccessMessage&&t.index.showToast({title:o.msg,icon:"none"}),e(o)):(0==o.code||400==o.code?!1!==i.showErrorMessage&&t.index.showToast({title:o.msg,icon:"none"}):this.handleAuthError(o.code),s(o))},fail:e=>{s(e)},complete:e=>{this.handleRequestFail(e)}})}))}handleAuthError(e){switch(e){case 401:r.useMemberStore().logout();break;case 402:if(-1!=o.currRoute().indexOf("app/pages/index/close"))return;o.redirect({url:"/app/pages/index/close",mode:"reLaunch"});break;case 403:if(-1!=o.currRoute().indexOf("app/pages/index/nosite"))return;o.redirect({url:"/app/pages/index/nosite",mode:"switchTab"})}}handleRequestFail(e){if(e.errMsg&&"request:ok"==e.errMsg&&"string"==typeof e.data){const e=this.baseUrl+i.t("baseUrlError");t.index.showToast({icon:"none",title:e})}else"request:fail"!=e.errMsg?e.errMsg&&"request:fail url not in domain list"==e.errMsg&&t.index.showToast({icon:"none",title:this.baseUrl+i.t("notInDomainList")}):t.index.showToast({icon:"none",title:this.baseUrl+i.t("requestFail")})}};exports.request=n;
