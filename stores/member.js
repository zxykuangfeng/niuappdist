"use strict";const e=require("../common/vendor.js"),i=require("../utils/common.js"),o=require("../app/api/member.js"),n=require("../app/api/auth.js");require("./config.js"),require("../utils/request.js"),require("./system.js");const t=e.defineStore("member",{state:()=>({token:e.index.getStorageSync("wapToken"),info:null,levelList:null}),actions:{setToken(e,o=null){this.token=e,i.setToken(e),this.getMemberInfo(o)},getMemberInfo(i=null){this.token&&o.getMemberInfo().then((o=>{this.info=o.data,e.index.setStorageSync("wap_member_info",this.info),e.index.setStorageSync("wap_member_id",o.data.member_id),this.info.mobile&&(e.index.removeStorageSync("isBindMobile"),e.index.setStorageSync("wap_member_mobile",this.info.mobile)),i&&i()})).catch((()=>{this.logout(),e.index.removeStorageSync("wap_member_mobile"),e.index.removeStorageSync("wap_member_id"),e.index.removeStorageSync("wap_member_not_control_mobile")}))},logout(o=!1){this.token&&(this.token="",this.info=null,e.index.setStorageSync("autoLoginLock",!0),n.logout().then((()=>{i.removeToken(),e.index.removeStorageSync("wap_member_info"),e.index.removeStorageSync("unionid"),e.index.removeStorageSync("isBindMobile"),e.index.removeStorageSync("nickname"),e.index.removeStorageSync("avatar"),o&&i.redirect({url:"/app/pages/index/index",mode:"switchTab"})})).catch((()=>{i.removeToken(),e.index.removeStorageSync("wap_member_info"),e.index.removeStorageSync("unionid"),e.index.removeStorageSync("isBindMobile"),e.index.removeStorageSync("nickname"),e.index.removeStorageSync("avatar"),o&&i.redirect({url:"/app/pages/index/index",mode:"switchTab"})})))},bindMobile(i){if("getPhoneNumber:ok"==i.detail.errMsg&&(e.index.showLoading({title:""}),o.bindMobile({mobile_code:i.detail.code}).then((i=>{e.index.hideLoading(),this.getMemberInfo()})).catch((()=>{setTimeout((()=>{e.index.hideLoading()}),2e3)}))),104==i.detail.errno){let i="用户未授权隐私权限";e.index.showToast({title:i,icon:"none"})}if("getPhoneNumber:fail user deny"==i.detail.errMsg){let i="用户拒绝获取手机号码";e.index.showToast({title:i,icon:"none"})}}}});exports.useMemberStore=t;
