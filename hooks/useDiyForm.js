"use strict";const e=require("../common/vendor.js"),a=require("../utils/common.js"),o=require("../app/api/diy_form.js"),l=require("../app/stores/diy.js"),t=require("./useLogin.js");exports.useDiyForm=function(r={}){const i=e.ref(!0),g=l.useDiyStore(),n=e.ref(r.form_id||0);e.ref(r.name||""),e.ref("");const d=e.ref(""),u=e.reactive({}),p=e.ref(r.needLogin||!1),s=e.reactive({pageMode:"diy",title:"",global:{},value:[],status:0}),c=e.computed((()=>"decorate"==g.mode?g:s)),v=e.ref(!1),m=(l=null)=>{let r=getCurrentPages();d.value=r[r.length-1]?r[r.length-1].route:"";let c=[];if(e.index.getStorageSync("diyPageBlank")&&(c=e.index.getStorageSync("diyPageBlank")),!c.length||c.length&&-1==c.indexOf(d.value)?g.topFixedStatus="home":c.length&&-1!=c.indexOf(d.value)&&(g.topFixedStatus="diy"),"decorate"==g.mode)g.init();else{if(!n.value)return;if(p.value&&!a.getToken())return void t.useLogin().setLoginBack({url:"/app/pages/index/diy_form",param:{form_id:n.value}});o.getDiyFormInfo({form_id:n.value}).then((o=>{if(Object.assign(u,o.data),s.status=o.data.status,u.value){s.pageMode=u.mode,s.title=u.title,g.id=u.form_id;let o=u.value,l=e.index.getStorageSync("diyFormStorage_"+g.id);if(l){var t=new Date;let r=parseInt(t.getTime()/1e3);l.validTime>r?l.components&&l.components.forEach((e=>{for(let l=0;l<o.value.length;l++)if("diy_form"==o.value[l].componentType&&e.id==o.value[l].id){let t=a.deepClone(e),r=a.deepClone(t.field);delete t.field,delete r.required,delete r.unique,delete r.autofill,delete r.privacyProtection,Object.assign(o.value[l],t),Object.assign(o.value[l].field,r);break}})):e.index.removeStorageSync("diyFormStorage_"+g.id)}g.value=o.value,s.global=o.global,s.value=o.value,s.value.forEach(((e,a)=>{e.isHidden?s.value.splice(a,1):(e.pageStyle="",("FormSubmit"!=e.componentName||"FormSubmit"==e.componentName&&"hover_screen_bottom"!=e.btnPosition)&&(e.pageStartBgColor&&(e.pageStartBgColor&&e.pageEndBgColor?e.pageStyle+=`background:linear-gradient(${e.pageGradientAngle},${e.pageStartBgColor},${e.pageEndBgColor});`:e.pageStyle+="background-color:"+e.pageStartBgColor+";"),e.margin&&(e.margin.top>0&&(e.pageStyle+="padding-top:"+2*e.margin.top+"rpx;"),e.pageStyle+="padding-bottom:"+2*e.margin.bottom+"rpx;",e.pageStyle+="padding-right:"+2*e.margin.both+"rpx;",e.pageStyle+="padding-left:"+2*e.margin.both+"rpx;")))})),v.value=s.value.some((e=>e&&e.position&&"top_fixed"==e.position)),e.index.setNavigationBarTitle({title:s.title})}i.value=!1,l&&l(u)}))}};return{getLoading:()=>i.value,requestData:u,data:c.value,isShowTopTabbar:v,pageStyle:()=>{var e="";return c.value.global.pageStartBgColor&&(c.value.global.pageStartBgColor&&c.value.global.pageEndBgColor?e+=`background:linear-gradient(${c.value.global.pageGradientAngle},${c.value.global.pageStartBgColor},${c.value.global.pageEndBgColor});`:e+="background-color:"+c.value.global.pageStartBgColor+";"),c.value.global.bottomTabBarSwitch?e+="min-height:calc(100vh - 50px);":e+="min-height:calc(100vh);",c.value.global.bgUrl&&(e+=`background-image:url('${a.img(c.value.global.bgUrl)}');`),c.value.global.bgHeightScale&&(e+=`background-size: 100% ${c.value.global.bgHeightScale}%;`),e},onLoad:(a=null)=>{e.onLoad((e=>{n.value=e.form_id||"",m(a)}))},onShow:(a=null)=>{e.onShow((()=>{a&&a(u)}))},onHide:(a=null)=>{e.onHide((()=>{let o=[];e.index.getStorageSync("diyPageBlank")&&(o=e.index.getStorageSync("diyPageBlank")),o.length&&(o=Array.from(new Set(o)),o.forEach(((e,a,o)=>{e==d.value&&o.splice(a,1)}))),"diy"==g.topFixedStatus&&o.push(d.value),e.index.setStorageSync("diyPageBlank",o),a&&a()}))},onUnload:()=>{e.onUnload((()=>{}))},onPageScroll:()=>{e.onPageScroll((e=>{e.scrollTop>0&&(g.scrollTop=e.scrollTop)}))},getData:m}};
